<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Uvateca - Gest√£o de Leitores</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="main-header"><a href="index.html" class="logo">Uvateca</a><div class="user-icon"><a href="#" id="user-icon-btn"><img src="menu.png" class="user-icon-img"></a></div></header>
    
    <aside id="user-sidebar" class="sidebar">
        <div id="sidebar-logado" class="sidebar-profile" style="display:none;"><img src="perfil.jpeg"><p id="welcome-msg-text"></p></div>
        <div id="sidebar-deslogado" class="sidebar-profile"><p>Deslogado</p></div>
        <nav class="sidebar-nav">
            <ul>
                <li id="nav-dashboard" style="display:none;"><a href="dashboard.html">Dashboard</a></li>
                <li id="nav-gestao-leitores" style="display:none;"><a href="gestao-leitores.html">üë• Gest√£o de Leitores</a></li>
                <li id="nav-acervo" style="display:none;"><a href="gestao-acervo.html">üìö Acervo Bibliogr√°fico</a></li>
                <li id="nav-gestao-emprestimos" style="display:none;"><a href="gestao-emprestimos.html">ü§ù Gest√£o de Empr√©stimos</a></li>
                
                <li id="nav-biblioteca" style="display:none;"><a href="minha-biblioteca.html">Minha Biblioteca</a></li>
                <li id="nav-alugados" style="display:none;"><a href="alugados.html">Meus Alugu√©is</a></li>
                <li id="nav-login"><a href="login.html">Sair</a></li>
            </ul>
        </nav>
    </aside>

    <main>
        <div class="container">
            <h2>üë• Gest√£o de Leitores</h2>
            
            <div class="form-container">
                <h3 id="form-title">Novo Leitor</h3>
                <form id="form-usuario">
                    <input type="hidden" id="cpfOriginal"> 
                    <input type="hidden" id="tipoUsuarioOculto"> 
                    
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" id="nome" required>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group"><label>CPF</label><input type="text" id="cpf" required placeholder="Apenas n√∫meros"></div>
                        <div class="form-group"><label>Telefone</label><input type="text" id="telefone"></div>
                    </div>

                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" id="email" required>
                    </div>

                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="senha" required placeholder="Senha de acesso">
                    </div>

                    <button type="submit" class="btn btn-secondary" id="btn-salvar">Cadastrar Leitor</button>
                    <button type="button" class="btn" id="btn-cancelar" style="display:none; background:#ccc;">Cancelar</button>
                </form>
            </div>

            <h3>Leitores Cadastrados</h3>
            <div style="overflow-x: auto;">
                <table class="management-table">
                    <thead><tr><th>Nome</th><th>CPF</th><th>Email</th><th>Tipo</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="tabela-usuarios"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="main.js"></script>
    <script>
        const API = "http://localhost:8080/api";
        let editando = false;

        document.addEventListener("DOMContentLoaded", carregarUsuarios);

        async function carregarUsuarios() {
            try {
                const res = await fetch(`${API}/usuarios`);
                const lista = await res.json();
                const tbody = document.getElementById("tabela-usuarios");
                tbody.innerHTML = "";
                
                lista.forEach(u => {
                    // Truque para aspas
                    const uJson = JSON.stringify(u).replace(/'/g, "&#39;");
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${u.nome}</td>
                            <td>${u.cpf}</td>
                            <td>${u.email}</td>
                            <td>${u.tipoUsuario || 'COMUM'}</td>
                            <td>
                                <button class="action-btn btn-edit" onclick='prepararEdicao(${uJson})'>‚úèÔ∏è</button>
                                <button class="action-btn btn-delete" onclick="excluirUsuario('${u.cpf}')">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            } catch(e) { console.error("Erro ao carregar usu√°rios", e); }
        }

        async function excluirUsuario(cpf) {
            if(!confirm("Tem certeza que deseja remover este usu√°rio?")) return;

            try {
                const res = await fetch(`${API}/usuarios/${cpf}`, { method: 'DELETE' });
                if (res.ok) {
                    alert("‚úÖ Usu√°rio exclu√≠do!");
                    carregarUsuarios();
                } else {
                    const msg = await res.text();
                    alert("‚ùå Erro ao excluir: " + msg);
                }
            } catch (error) {
                alert("‚ùå Erro de conex√£o ao excluir.");
            }
        }

        function prepararEdicao(user) {
            editando = true;
            document.getElementById("form-title").innerText = "Editando: " + user.nome;
            document.getElementById("cpfOriginal").value = user.cpf;
            
            document.getElementById("tipoUsuarioOculto").value = user.tipoUsuario || "COMUM";
            
            document.getElementById("nome").value = user.nome;
            document.getElementById("cpf").value = user.cpf;
            document.getElementById("email").value = user.email;
            document.getElementById("telefone").value = user.telefone;
            
            document.getElementById("senha").placeholder = "Digite nova senha para alterar";
            document.getElementById("senha").required = false;
            // Opcional: preencher senha atual se o back-end mandar, 
            // mas por seguran√ßa geralmente √© melhor deixar vazio.
            document.getElementById("senha").value = user.senha || ""; 

            document.getElementById("btn-salvar").innerText = "Atualizar Dados";
            document.getElementById("btn-cancelar").style.display = "inline-block";
            window.scrollTo(0,0);
        }

        document.getElementById("btn-cancelar").onclick = function() {
            document.getElementById("form-usuario").reset();
            editando = false;
            document.getElementById("form-title").innerText = "Novo Leitor";
            document.getElementById("btn-salvar").innerText = "Cadastrar Leitor";
            document.getElementById("senha").required = true;
            document.getElementById("tipoUsuarioOculto").value = ""; 
            this.style.display = "none";
        };

        document.getElementById("form-usuario").onsubmit = async function(e) {
            e.preventDefault();
            
            const tipoFinal = editando ? document.getElementById("tipoUsuarioOculto").value : "COMUM";

            const usuario = {
                nome: document.getElementById("nome").value,
                cpf: document.getElementById("cpf").value,
                email: document.getElementById("email").value,
                telefone: document.getElementById("telefone").value,
                senha: document.getElementById("senha").value,
                tipoUsuario: tipoFinal
            };

            try {
                if(editando) {
                    const cpfOriginal = document.getElementById("cpfOriginal").value;
                    const res = await fetch(`${API}/usuarios/${cpfOriginal}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(usuario)
                    });
                    
                    if(res.ok) {
                        alert("‚úÖ Usu√°rio atualizado!");
                        document.getElementById("btn-cancelar").click();
                        carregarUsuarios();
                    } else {
                        alert("‚ùå Erro ao atualizar: " + await res.text());
                    }
                } else {
                    const res = await fetch(`${API}/usuarios/cadastro`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(usuario)
                    });
                    
                    if(res.ok) {
                        alert("‚úÖ Leitor cadastrado!");
                        document.getElementById("btn-cancelar").click();
                        carregarUsuarios();
                    } else {
                        alert("‚ùå Erro ao cadastrar: " + await res.text());
                    }
                }
            } catch(e) {
                alert("‚ùå Erro de conex√£o com o servidor.");
            }
        };
    </script>
</body>
</html>